console.log('--- [BOOT CHECK] Loading server.js v5.6.0 (S2S Router Migration) ---');
/**
 * PZ Auth+API Backend (v5.6.0 - S2S Router Migration)
 * Vers√£o: 5.6.0
 * Data: 2025-11-13
 * Autor: PZ Advisors
 *
 * Objetivo: Migra o processamento de S2S (webhook) para a nova arquitetura
 * PostbackRouter, substituindo as rotas /webhook/*.
 * - [P1] Importa o PostbackRouter.
 * - [P1] Substitui app.get('/webhook/digistore24') e app.post('/webhook/clickbank')
 * por uma rota √∫nica: app.all('/postback/:platform').
 * - Mant√©m todas as funcionalidades v5.5.8.
 */

// 1) Imports
const express = require('express');
const cors = require('cors');
const cookieParser = require('cookie-parser');
const crypto = require('crypto');
const { initializeApp, cert } = require('firebase-admin/app');
const { getFirestore, FieldValue, Timestamp } = require('firebase-admin/firestore');
const { OAuth2Client } = require('google-auth-library');

// Carrega os m√≥dulos
const marketingAutomator = require('./marketingAutomator');
const PlatformAdapterBase = require('./PlatformAdapterBase');
// --- IN√çCIO DA ALTERA√á√ÉO v5.6.0 ---
// Importa o novo roteador S2S
const PostbackRouter = require('./PostbackRouter');
// --- FIM DA ALTERA√á√ÉO v5.6.0 ---

// 2) Constantes e Configura√ß√£o do Servidor
const SERVER_VERSION = '5.6.0'; // ATUALIZADO
const SERVER_DEPLOY_DATE = '2025-11-13'; // ATUALIZADO
const PORT = process.env.PORT || 8080;
const TRACE_ID_HEADER = 'x-request-trace-id';
const USE_SECURE_COOKIES = process.env.NODE_ENV === 'production';

// 3) Configura√ß√£o de CORS (v5.5.4: Restaurado allowlist da v5.5.2)
const allowedOrigins = [
  'https://pzadvisors.com',
  'https://www.pzadvisors.com',
  'https://auth.pzadvisors.com',
  'https://api.pzadvisors.com',
];
if (process.env.NODE_ENV !== 'production') {
  allowedOrigins.push('http://localhost:8080');
  allowedOrigins.push('http://127.0.0.1:8080');
  allowedOrigins.push('http://localhost:3000');
}
const corsOptions = {
  origin: (origin, callback) => {
    // (P0-SEC) CORS Restrito
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error(`CORS: Origem n√£o permitida: ${origin}`));
    }
  },
  credentials: true,
};

// 4) Configura√ß√£o de Clientes Google Auth
const GOOGLE_CLIENT_IDS = [
  process.env.GOOGLE_CLIENT_ID_PZADVISORS,
  process.env.GOOGLE_CLIENT_ID_LANDER_B,
].filter(Boolean);

if (!GOOGLE_CLIENT_IDS.length) {
  console.warn('[AUTH] Aviso: Nenhum GOOGLE_CLIENT_ID_* configurado.');
}
const googleAuthClients = GOOGLE_CLIENT_IDS.map(id => new OAuth2Client(id));

// 5) Configura√ß√£o de Tracking
const TRACK_TOKEN_ENABLED = !!process.env.TRACK_TOKEN;
const TRACK_TOKEN_DEBUG_ENABLED = !!process.env.TRACK_TOKEN_DEBUG;
const TRACK_OPEN = process.env.TRACK_OPEN === 'true';

// 6) Configura√ß√£o do Firebase Admin SDK
let db; 
let FIRESTORE_SOURCE_LOG = 'N/A';
let FIRESTORE_PROJECT_ID = 'N/A';
let FIRESTORE_INIT = false; 

function ensureSA() {
  if (process.env.FIREBASE_SERVICE_ACCOUNT_JSON) {
    try {
      const sa = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT_JSON);
      FIRESTORE_SOURCE_LOG = 'env_json';
      FIRESTORE_PROJECT_ID = sa.project_id;
      return sa;
    } catch (e) { console.error('[FS][ERRO] Falha ao parsear FIREBASE_SERVICE_ACCOUNT_JSON:', e?.message); }
  }
  if (process.env.GCP_PROJECT_ID && process.env.GCP_SA_EMAIL && process.env.GCP_SA_PRIVATE_KEY) {
     try {
       const sa = {
         project_id: process.env.GCP_PROJECT_ID,
         client_email: process.env.GCP_SA_EMAIL,
         private_key: process.env.GCP_SA_PRIVATE_KEY.replace(/\\n/g, '\n'),
       };
       FIRESTORE_SOURCE_LOG = 'env_split';
       FIRESTORE_PROJECT_ID = sa.project_id;
       return sa;
     } catch (e) { console.error('[FS][ERRO] Falha ao montar SA das Vercel vars:', e?.message); }
  }
  if (process.env.GOOGLE_APPLICATION_CREDENTIALS) {
     FIRESTORE_SOURCE_LOG = 'gcp_auto';
     FIRESTORE_PROJECT_ID = process.env.GCP_PROJECT_ID || process.env.PROJECT_ID || 'gcp_auto_project';
     return null;
  }
  console.error('[FS][FATAL] Nenhuma credencial (FIREBASE_SERVICE_ACCOUNT_JSON ou GCP_*) foi encontrada.');
  throw new Error('sa_not_configured');
}

function initAdmin() {
  try {
    const serviceAccount = ensureSA();
    initializeApp(serviceAccount ? { credential: cert(serviceAccount) } : {});
    db = getFirestore();
    db.settings({ ignoreUndefinedProperties: true });
    FIRESTORE_INIT = true;
    console.log(`[ADMIN] Firebase SDK OK (Proj: ${FIRESTORE_PROJECT_ID} )`);
  } catch (e) {
    FIRESTORE_INIT = false;
    console.error('[ADMIN][FATAL] Falha ao inicializar Firebase Admin SDK:', e?.message);
    if (e.message === 'sa_not_configured') {
       if(process.env.SA_OPTIONAL !== 'true') { throw e; }
       console.warn('[ADMIN] SA_OPTIONAL=true. Servidor iniciando sem Firestore.');
    } else { throw e; }
  }
}

// 7) Inicializa√ß√£o dos Adapters
let ADAPTERS_LOADED = false;
try {
  if (PlatformAdapterBase) {
      ADAPTERS_LOADED = true;
      console.log('[BOOT] M√≥dulo PlatformAdapterBase (Factory) carregado.');
  }
} catch (e) {
  console.error('[BOOT][FATAL] Falha ao carregar PlatformAdapterBase:', e.message);
  throw e;
}
try {
  if (marketingAutomator) console.log('[BOOT] M√≥dulo marketingAutomator carregado com sucesso.');
} catch (e) {}

// 8) Middlewares
const app = express();
app.set('trust proxy', 1);

// --- IN√çCIO DA ALTERA√á√ÉO v5.5.6: Middleware de Trace ID movido para o TOPO ---
// (Req B) Garante que *todas* as respostas, incluindo erros de CORS, tenham Trace ID.
app.use((req, res, next) => {
  const traceId = req.headers[TRACE_ID_HEADER] || crypto.randomUUID();
  req.traceId = traceId;
  res.setHeader(TRACE_ID_HEADER, traceId);
  const start = process.hrtime.bigint();
  res.on('finish', () => {
    const end = process.hrtime.bigint();
    const duration = (end - start) / 1_000_000n;
    let logMsg = `[${req.method}] ${req.path} (${res.statusCode}) - ${duration}ms - [Trace: ${traceId}]`;
    if (res.locals.errorLog) { logMsg += ` - [ERROR: ${res.locals.errorLog}]`; }
    // N√£o logar healthz para reduzir ru√≠do
    if (req.path !== '/healthz' && req.path !== '/api/healthz') {
        console.log(logMsg);
    }
  });
  next();
});
// --- FIM DA ALTERA√á√ÉO v5.5.6 ---

app.use(cors(corsOptions));
app.use(cookieParser());

// --- IN√çCIO DA ALTERA√á√ÉO v5.5.5: Friendly CORS Error (NIT) ---
// (Deve vir *depois* de app.use(cors(corsOptions)))
app.use((err, req, res, next) => {
  if (err && /^CORS: Origem n√£o permitida/.test(err.message)) {
    res.locals.errorLog = `cors_forbidden:${req.headers.origin}`;
    // (v5.5.6) req.traceId agora est√° dispon√≠vel
    return res.status(403).json({ ok:false, error:'cors_forbidden', origin:req.headers.origin || null, rid: req.traceId });
  }
  next(err);
});
// --- FIM DA ALTERA√á√ÉO v5.5.5 ---

// --- IN√çCIO DA ALTERA√á√ÉO v5.5.4: L√≥gica de Autentica√ß√£o (P0-SEC) ---
function getApiToken(req) {
  const h = req.get('X-Api-Token') || req.get('x-api-token') || req.get('x-api-key');
  const b = req.body?.auth?.api_token || req.body?.api_token;
  const q = req.query?.api_token || req.query?.token; 
  return h || b || q || null;
}

// (P0-SEC) Carrega tokens *apenas* do .env
const VALID_TOKENS = new Set(
  [
    process.env.TRACK_TOKEN, 
    process.env.TRACK_TOKEN_DEBUG
  ].filter(Boolean)
);
if (VALID_TOKENS.size === 0 && !TRACK_OPEN) {
    console.warn('[AUTH] Nenhum TRACK_TOKEN ou TRACK_TOKEN_DEBUG definido no .env. /api/track pode falhar.');
}

function isValidToken(tok) {
  if (TRACK_OPEN) return true; 
  if (!tok) return false;
  return VALID_TOKENS.has(String(tok));
}
// --- FIM DA ALTERA√á√ÉO v5.5.4 ---


// =================================================================
// 9) Utils de Daily Facts (Base v5.5.3)
// =================================================================
function zeroPad(n, w = 2) { return String(n).padStart(w, '0'); }
function deriveDayParts(tsISO, tzOffsetMin) { let d=tsISO?new Date(tsISO):new Date(); const tz=Number.isFinite(+tzOffsetMin)?+tzOffsetMin:0; if(tz!==0) d=new Date(d.getTime()+tz*60*1000); return { y:d.getUTCFullYear(), m:zeroPad(d.getUTCMonth()+1), d:zeroPad(d.getUTCDate()) }; }
function deriveDayLabel(tsISO, tzOffsetMin) { const p=deriveDayParts(tsISO,tzOffsetMin); return `${p.y}-${p.m}-${p.d}`; }

function parseClientTimestamp(val) { 
  try{ 
    if(!val) return null; 
    const d=new Date(val); 
    if(isNaN(d.getTime())) return null; 
    return Timestamp.fromDate(d);
  } catch { return null; } 
}
function toPlainJSON(obj) { try { return JSON.parse(JSON.stringify(obj || null)); } catch { return null; } }

// (v5.5.3) Higiene de Dados
function clean(v) {
  if (v === undefined || v === null) return ""; 
  const s = String(v).trim();
  if (s === 'null' || s === '"null"' || s === "'null'") return ""; 
  return s;
}

/**
 * L√≥gica de grava√ß√£o (Base v5.5.3)
 */
async function upsertDailyFact({ db = null, anon_id, user_id, tz_offset, event, page, session_id, payload, tsISO }) {
  if (!FIRESTORE_INIT || !db) {
    console.warn(`[upsertDailyFact] DB n√£o dispon√≠vel (SA_OPTIONAL=true). Pulando grava√ß√£o.`);
    return { ok: false, id: null, error: 'DB_NOT_INITIALIZED' };
  }

  // (P0 v5.5.3) Aplica Higiene
  if (payload && payload.got && typeof payload.got === 'object') {
      Object.keys(payload.got).forEach(k => {
          const cleanedValue = clean(payload.got[k]); 
          if (cleanedValue === "") {
             delete payload.got[k]; // Remove chaves vazias
          } else {
             payload.got[k] = cleanedValue;
          }
      });
  }

  const safeAnon = (anon_id && typeof anon_id === 'string') ? anon_id : 'anon_unknown';
  const tz = Number.isFinite(+tz_offset) ? +tz_offset : 0;
  const day = deriveDayLabel(tsISO, tz);
  
  const docIdPattern = process.env.FACTS_DOC_PATTERN || '${anon_id}_${YYYY-MM-DD}';
  const docId = docIdPattern
    .replace('${anon_id}', safeAnon)
    .replace('${YYYY-MM-DD}', day)
    .replace('${y}', deriveDayParts(tsISO, tz).y) 
    .replace('${m}', deriveDayParts(tsISO, tz).m)
    .replace('${d}', deriveDayParts(tsISO, tz).d);

  const docRef = db.collection(process.env.FIRESTORE_FACTS_COLLECTION || 'daily_facts').doc(docId);
  
  const event_id = payload?.event_id || `${Date.now()}-${Math.random().toString(36).slice(2,10)}`;
  
  if (payload.event_id) delete payload.event_id;
  
  const newEvent = toPlainJSON({ 
    event, 
    event_id, 
    ts_server: FieldValue.serverTimestamp(), 
    ts_client: parseClientTimestamp(tsISO), 
    tz_offset: Number.isFinite(tz) ? tz : null, 
    page, 
    session_id, 
    payload 
  });
  
  const final_user_id = (user_id && typeof user_id === 'string') ? user_id : null;
  const final_person_id = final_user_id || safeAnon;

  const updatePayload = {
    updated_at: FieldValue.serverTimestamp(),
    events: FieldValue.arrayUnion(newEvent),
    [`counters.${event}`]: FieldValue.increment(1),
    person_id: final_person_id, 
    ...(final_user_id ? { user_id: final_user_id } : {})
  };
  
  try {
    await docRef.update(updatePayload);
  } catch (error) {
    const notFound = error?.code === 5 || error?.code === 'not-found' || /NOT_FOUND/i.test(error?.message || '');
    if (notFound) {
      const seedPayload = {
        kind: 'user', date: day, entity_id: safeAnon, anon_id: safeAnon,
        person_id: final_person_id, 
        ...(final_user_id ? { user_id: final_user_id } : {}),
        ...(Number.isFinite(tz) ? { tz_offset: tz } : {}),
        events: [newEvent], 
        counters: { [event]: 1 },
        created_at: FieldValue.serverTimestamp(), 
        updated_at: FieldValue.serverTimestamp()
      };
      await docRef.set(seedPayload);
    } else {
      if (error.code === 6 || /ALREADY_EXISTS/i.test(error.message)) {
         console.warn(`[TRACK] Ignorando evento duplicado (idempot√™ncia): ${docId} / ${event_id}`);
         return { ok: true, id: docId, op: 'ignored_duplicate' };
      }
      console.error(JSON.stringify({ tag: 'upsert_daily_fact_failed', docId, error: error.message || String(error), code: error.code }));
      throw error;
    }
  }
  return { ok: true, id: docId };
}


// 10) Rotas da API

// --- Rotas P√∫blicas (Health & Version) --- 
const HEALTHZ_TS = new Date().toISOString();
let HEALTHZ_UPTIME_START = process.hrtime.bigint();

app.get('/healthz', (req, res) => {
    const uptimeNano = process.hrtime.bigint() - HEALTHZ_UPTIME_START;
    const uptimeSec = Number(uptimeNano) / 1_000_000_000;
    res.status(200).json({ ok: true, uptime: uptimeSec, ts: new Date().toISOString() });
});
app.get('/api/healthz', (req, res) => {
    const uptimeNano = process.hrtime.bigint() - HEALTHZ_UPTIME_START;
    const uptimeSec = Number(uptimeNano) / 1_000_000_000;
    res.status(200).json({ ok: true, uptime: uptimeSec, ts: new Date().toISOString() });
});
app.get('/api/version', (req, res) => {
  // (v5.5.4 BC)
  res.status(200).json({
    service: 'PZ Auth+API Backend', version: SERVER_VERSION, build_date: SERVER_DEPLOY_DATE,
    adapters_loaded: ADAPTERS_LOADED, client_ids: GOOGLE_CLIENT_IDS, origins: allowedOrigins,
    track_open: TRACK_OPEN, 
    track_token_env: TRACK_TOKEN_ENABLED, 
    debug_token_env: TRACK_TOKEN_DEBUG_ENABLED, 
    track_token: TRACK_TOKEN_ENABLED, 
    debug_token: TRACK_TOKEN_DEBUG_ENABLED, 
    fs_auth: FIRESTORE_INIT ? 'AdminSDK' : 'None', 
    fs_init: FIRESTORE_INIT, fs_project: FIRESTORE_PROJECT_ID,
    fs_sa_source: FIRESTORE_SOURCE_LOG, facts_coll: process.env.FIRESTORE_FACTS_COLLECTION || 'daily_facts',
    tx_coll: process.env.FIRESTORE_TRANSACTIONS_COLLECTION || 'affiliate_transactions',
    facts_doc_pattern: process.env.FACTS_DOC_PATTERN || '${anon_id}_${YYYY-MM-DD}',
  });
});

// --- Rota P√∫blica (Google Auth) --- (como v5.0.8)
app.post('/auth/google', express.json(), async (req, res) => {
  // (L√≥gica v5.5.2 mantida)
  const { credential } = req.body;
  if (!credential) {
    res.locals.errorLog = 'credential_missing';
    return res.status(400).json({ ok: false, error: 'credential_missing', rid: req.traceId });
  }
  let ticket; let verified = false;
  for (const client of googleAuthClients) {
    try {
      ticket = await client.verifyIdToken({ idToken: credential, audience: GOOGLE_CLIENT_IDS });
      if (ticket) { verified = true; break; }
    } catch (e) { console.warn(`[AUTH] Falha na verifica√ß√£o GSI (Cliente: ${client.clientId_?.slice(0,10)}...): ${e.message}`); }
  }
  if (!verified || !ticket) {
    res.locals.errorLog = 'google_token_invalid';
    return res.status(401).json({ ok: false, error: 'google_token_invalid', rid: req.traceId });
  }
  const payload = ticket.getPayload();
  const { sub, email, name, given_name, family_name, picture } = payload;
  if (!sub || !email) {
    res.locals.errorLog = 'google_payload_incomplete';
    return res.status(400).json({ ok: false, error: 'google_payload_incomplete', rid: req.traceId });
  }
  try {
    if (db) {
        const userRef = db.collection('users').doc(sub);
        const userData = {
          user_id: sub, email: email, name: name || '', first_name: given_name || '', last_name: family_name || '',
          picture: picture || '', auth_provider: 'google', last_seen_at: new Date(), created_at: new Date(),
        };
        const doc = await userRef.get();
        if (doc.exists) { await userRef.update({ last_seen_at: new Date() }); }
        else { await userRef.set(userData); }
    } else {
        console.warn(`[AUTH] Firestore (db) n√£o dispon√≠vel. Grava√ß√£o 'users' pulada. [Trace: ${req.traceId}]`);
    }
    res.status(200).json({ ok: true, user_id: sub, email: email });
  } catch (fsError) {
    res.locals.errorLog = 'firestore_error_auth';
    console.error(`[AUTH][500] Erro ao salvar user no Firestore (User: ${sub}):`, fsError);
    res.status(500).json({ ok: false, error: 'firestore_error', rid: req.traceId });
  }
});

// --- Rota P√∫blica (API de Marketing / Send Guide) --- (v5.5.5: Hotfix 404)
app.post('/api/send-guide', express.json(), async (req, res) => {
  const { user_id } = req.body;
  if (!user_id) {
    res.locals.errorLog = 'user_id_missing';
    return res.status(400).json({ ok: false, error: 'user_id_missing', rid: req.traceId });
  }
  try {
    let email = null;
    let first_name = '';

    if (db) {
        const userRef = db.collection('users').doc(user_id);
        const userDoc = await userRef.get();
        if (!userDoc.exists) {
          res.locals.errorLog = 'user_not_found_guide';
          // (v5.5.5 Hotfix)
          return res.status(404).json({ ok: false, error: 'user_not_found', rid: req.traceId });
        }
        const userData = userDoc.data();
        email = userData.email;
        first_name = userData.first_name;
    } else {
        console.warn(`[GUIDE] Firestore (db) n√£o dispon√≠vel. Leitura 'users' pulada. [Trace: ${req.traceId}]`);
        email = req.body.email; 
    }

    if (!email) {
       res.locals.errorLog = 'user_email_missing_guide';
      return res.status(400).json({ ok: false, error: 'user_email_missing', rid: req.traceId });
    }
    
    const subscriberInfo = {
      email: email, first_name: first_name || '',
      fields: {
        user_id_google: user_id, anon_id: req.body.anon_id || null,
        attribution_history_json: JSON.stringify(req.body.attribution_history || []),
        product_choice: req.body.product_choice || null,
      }
    };
    const ckResponse = await marketingAutomator.addSubscriberToFunnel(subscriberInfo);
    res.status(200).json({ ok: true, message: 'Guide request processed.', subscriber: ckResponse });
  } catch (error) {
    res.locals.errorLog = `marketing_api_error:${error.message}`;
    console.error(`[GUIDE][500] Falha ao processar guia (User: ${user_id}):`, error?.message || error);
    if (error.response) {
       return res.status(error.response.status || 502).json({
         ok: false, error: 'marketing_api_error', details: error.response.data, rid: req.traceId
       });
    }
    res.status(500).json({ ok: false, error: 'internal_server_error', rid: req.traceId });
  }
});

// --- Rota Protegida (API de Checkout / Adapter Factory) --- (como v5.0.8)
app.post('/api/checkout', express.json(), async (req, res) => {
  // (L√≥gica v5.5.2 mantida)
  console.log(`[SERVER CHECKOUT] req.body recebido (Trace: ${req.traceId}):`, JSON.stringify(req.body)); 
  
  const { offerData, trackingParams } = req.body;
  
  console.log(`[SERVER CHECKOUT] offerData extra√≠do (Trace: ${req.traceId}):`, JSON.stringify(offerData)); 

  if (!offerData || !offerData.affiliate_platform) {
    res.locals.errorLog = 'platform_missing_checkout';
    return res.status(400).json({ ok: false, error: 'offerData.affiliate_platform_missing', rid: req.traceId });
  }
  
  const platform = offerData.affiliate_platform;

  try {
    const adapter = PlatformAdapterBase.getInstance(platform);
    
    console.log(`[SERVER CHECKOUT] Passando offerData para o adapter ${platform} (Trace: ${req.traceId}):`, JSON.stringify(offerData)); 
    
    const finalCheckoutUrl = await adapter.buildCheckoutUrl(offerData, trackingParams);

    if (finalCheckoutUrl) {
      res.status(200).json({ ok: true, finalCheckoutUrl: finalCheckoutUrl });
    } else {
       res.locals.errorLog = `adapter_returned_null:${platform}`;
       console.warn(`[CHECKOUT][400] Adapter ${platform} retornou URL nula. [Trace: ${req.traceId}]`);
       res.status(400).json({ ok: false, error: 'checkout_url_generation_failed', platform: platform, rid: req.traceId });
    }
  } catch (error) {
    res.locals.errorLog = `adapter_factory_error:${platform}:${error.message}`;
    console.error(`[CHECKOUT][500] Falha na Factory ou Adapter (${platform}):`, error?.message || error);
    res.status(500).json({
      ok: false, error: 'adapter_error', platform: platform, details: error.message, rid: req.traceId
    });
  }
});

// --- Rota Protegida (API de Tracking / Eventos) --- (v5.5.6: Polimento Nit)
app.post('/api/track', express.json({ limit: '256kb' }), async (req, res) => {
    
    // (v5.5.3) Pixel Fallback
    try {
        // (P0-DOC) Nota: b64 fallback requer ?api_token=TOKEN na URL
        if (!req.body?.event && req.query?.b64) {
            const decoded = JSON.parse(Buffer.from(String(req.query.b64), 'base64').toString('utf8'));
            req.body = decoded;
            console.log(`[TRACK] Processando fallback b64. [Trace: ${req.traceId}]`);
        }
    } catch (e) {
        console.warn(`[TRACK] Falha ao decodificar b64 fallback: ${e.message}. [Trace: ${req.traceId}]`);
    }

    // (v5.5.4) Autentica√ß√£o Flex√≠vel
    const token = getApiToken(req);
    if (!isValidToken(token)) {
        res.locals.errorLog = 'invalid_api_token';
        return res.status(401).json({ ok: false, error: 'unauthorized', rid: req.traceId });
    }

    // (v5.5.3) Leitura Correta do Evento
    const eventName = (req.body?.event || req.body?.payload?.event || 'page_view_type') + '';
    const payload = req.body?.payload || req.body; 
    
    // (v5.5.5) Mantido para logs/compat
    if (payload.event !== eventName) {
        payload.event = eventName;
    }

    if (!eventName || !payload) { // Valida√ß√£o
        res.locals.errorLog = 'event_payload_missing';
        return res.status(400).json({ ok: false, error: 'event_or_payload_missing', rid: req.traceId });
    }

    try {
        const result = await upsertDailyFact({
            db: db, 
            anon_id: payload?.anon_id || null, 
            user_id: payload?.user_id || null, 
            tz_offset: payload?.tz_offset,
            event: eventName, // <-- (P0) USA O EVENTNAME CORRETO
            page: payload?.page || payload?.context?.page,
            session_id: payload?.session_id,
            payload: (() => { 
                const p = { ...payload }; 
                delete p.ts; delete p.tz_offset; delete p.page; delete p.session_id; 
                delete p.user_id; delete p.anon_id; delete p.context;
                delete p.auth; 
                delete p.event_id; 
                // --- IN√çCIO DA ALTERA√á√ÉO v5.5.6: (Nit) Remove dele√ß√£o redundante ---
                // 'p.event' √© mantido para logs no FB, e n√£o √© um campo de 1¬∫ n√≠vel em 'newEvent'
                // delete p.event; // (Removido na v5.5.6)
                // --- FIM DA ALTERA√á√ÉO v5.5.6 ---
                return toPlainJSON(p); 
            })(),
            tsISO: payload?.ts || new Date().toISOString()
        });

        if (result.ok) {
            res.status(200).json({ ok: true, rid: req.traceId, doc_id: result.id, op: result.op || 'merged/set' });
        } else if (result.error === 'DB_NOT_INITIALIZED') {
            res.locals.errorLog = 'firestore_not_initialized';
            res.status(200).json({ ok: true, rid: req.traceId, warning: 'db_not_initialized' });
        } else {
            throw new Error(result.error || 'upsert_failed');
        }
        
    } catch (fsError) {
        res.locals.errorLog = 'firestore_error_track';
        console.error(`[TRACK][500] Erro ao salvar evento '${eventName}' no Firestore:`, fsError);
        res.status(500).json({ ok: false, error: 'firestore_error', rid: req.traceId });
    }
});

// --- IN√çCIO DA ALTERA√á√ÉO v5.6.0: (Migra√ß√£o S2S Router) ---
// As rotas /webhook/digistore24 e /webhook/clickbank foram removidas
// e substitu√≠das pela rota √∫nica /postback/:platform, gerenciada
// pelo PostbackRouter.

// --- Rotas P√∫blicas (Webhooks S2S das Plataformas) ---
app.all('/postback/:platform', PostbackRouter.handle);
// --- FIM DA ALTERA√á√ÉO v5.6.0 ---


// 10) Start
try {
  initAdmin();
  app.listen(PORT, () => {
    HEALTHZ_UPTIME_START = process.hrtime.bigint();
    console.log('\n' + '‚îÄ'.repeat(60));
    console.log(`‚úÖ Server UP on port ${PORT}`);
    console.log(`üì¶ Version: ${SERVER_VERSION} (${SERVER_DEPLOY_DATE})`);
    console.log('üîß Config:');
    console.log(`   - CORS Origens : ${allowedOrigins.slice(0, 3).join(', ')}... (v5.5.4: Restrito)`); 
    console.log(`   - Google Auth  : ${GOOGLE_CLIENT_IDS.length} Client ID(s)`);
    console.log(`   - Track Aberto : ${TRACK_OPEN}`);
    console.log(`   - Track Token  : ${TRACK_TOKEN_ENABLED ? 'Sim (Env)' : 'N√£o (Env)'} (Valida√ß√£o: ${VALID_TOKENS.size} chaves, s/ fallback)`); 
    console.log(`   - Debug Token  : ${TRACK_TOKEN_DEBUG_ENABLED ? 'Sim (Env)' : 'N√£o (Env)'}`);
    console.log(`   - Firestore    : ${FIRESTORE_INIT ? `Admin SDK (Fonte: ${FIRESTORE_SOURCE_LOG}) ‚úÖ` : 'Desconectado ‚ùå'}`);
    console.log(`   - Adapters     : ${ADAPTERS_LOADED ? '‚úÖ' : '‚ùå'}`);
    console.log(`   - Guia URL Base: ${process.env.GUIDE_REDIRECT_BASE_URL || 'N/A'}`);
    console.log(`   - NODE_ENV     : ${process.env.NODE_ENV || 'undefined'}`);
    console.log('‚îÄ'.repeat(60));
  });
} catch (e) {
  console.error('[FATAL] Erro ao iniciar servidor:', e?.message || e);
  process.exit(1);
}